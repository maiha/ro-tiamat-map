# マップ画像解析仕様書

## 目的
ゲーム攻略用のマップデータ（JSON形式）を作成するため、既存の攻略サイトの画像とテキスト情報を解析する。

## 入力データ

### 1. 画像ファイル
- **nyuto.png**: 階層構造が明確で視覚的にわかりやすいマップ図
  - 特徴：各塔の1F-4F（または屋上、天文台）の階層が明示
  - 色分け：黄色=森林/草原系、緑=祭祀系、紫=城壁通路系
  - 矢印：緑=通常WP、赤=条件付きWP

- **ea212f02.jpg**: 詳細な接続情報を持つマップ図
  - 特徴：赤い円=WP位置、緑の注釈=解放条件やイベント情報
  - より複雑な接続関係が記載されている

### 2. テキストデータ
- **routing.html**: 攻略順序のタイムスケジュール
  - マップ名の正確な表記（接頭辞: [祭祀]、[森林]、[草原]、[ボス]、[・]）
  - 移動順序と時刻
  - 特殊ギミック情報（グローザ像クイズ、天文台解除、水門開放など）

## 抽出すべき情報

### マップ情報（maps配列）
各マップについて以下の情報を抽出：

1. **id** (string): マップの一意識別子（例: "tower_south1_1f"）
   - 命名規則: エリア名_階層情報（小文字、アンダースコア区切り）

2. **name** (string): マップの表示名（例: "塔・南①1F"）
   - routing.htmlの表記を正として使用

3. **floor** (number): 階層番号
   - 地下=0以下、1F=1、2F=2、...、屋上=4、天文台=5

4. **area** (string): 所属エリア（例: "tower_south1", "wall2f"）
   - エリア分類: tower_south1, tower_southwest, tower_west, tower_northwest, tower_north1, gate1, wall2f, wall_route, courtyard, well

5. **enemyType** (string): 敵の種類（マップの色から判定）
   - "yellow": 祭祀系（黄色のマップ）
   - "green": 森林/草原系（緑のマップ）
   - "purple": 城壁通路系（紫のマップ）

6. **description** (string): マップの説明
   - routing.htmlの接頭辞情報（[祭祀]、[森林]など）
   - ボス情報（例: "ボス(デヒョン戦、ソード)"）
   - ギミック情報（例: "グローザ像クイズ"、"天文台解除"）

### WP接続情報（warps配列）
各WP（ワープポイント）について以下の情報を抽出：

1. **from** (string): 出発マップのid

2. **to** (string): 到着マップのid

3. **direction** (string): 移動方向（視覚的な理解を助けるため）
   - "up": 上の階へ
   - "down": 下の階へ
   - "north", "south", "east", "west": 水平方向の移動

4. **locked** (boolean): 解放条件の有無
   - true: 条件を満たすまで利用不可
   - false: 常時利用可能

5. **condition** (string, optional): 解放条件の説明文（lockedがtrueの場合のみ）
   - 例: "城門①3Fクリア後"、"天文台解除"、"グローザ像クイズ完了後"

### メタデータ（metadata）
- **enemyTypes**: 敵タイプの説明
- **areas**: エリア名の説明

## 解析手順

### ステップ1: マップ一覧の抽出
1. nyuto.pngとea212f02.jpgからすべてのマップ名を抽出
2. routing.htmlと照合して正確な表記を確定
3. 重複排除とマップIDの生成

### ステップ2: 階層情報の特定
1. nyuto.pngから各マップの階層（1F, 2F, 屋上など）を読み取り
2. エリアごとにグループ化

### ステップ3: WP接続の抽出
1. 画像から矢印を追跡してマップ間の接続を特定
2. 矢印の色で条件付きWPを判別（赤=条件付き、緑=通常）
3. routing.htmlの移動順序から推論して接続を補完

### ステップ4: 条件付きWPの解放条件抽出
1. 画像の注釈テキストを読み取り
2. routing.htmlの特殊ギミック情報を参照
3. 条件文を自然な日本語で記述

### ステップ5: メタデータの抽出
1. マップの色分けから敵タイプを分類
2. routing.htmlの接頭辞情報を統合

## 出力形式

JSON形式で出力（map-data.json）。構造は以下の通り：

```json
{
  "maps": [
    {
      "id": "マップID",
      "name": "マップ名",
      "floor": 階層番号,
      "area": "エリア名",
      "enemyType": "敵タイプ",
      "description": "説明文"
    }
  ],
  "warps": [
    {
      "from": "出発マップID",
      "to": "到着マップID",
      "direction": "方向",
      "locked": true/false,
      "condition": "解放条件（lockedがtrueの場合のみ）"
    }
  ],
  "metadata": {
    "enemyTypes": {
      "yellow": "説明",
      "green": "説明"
    },
    "areas": {
      "エリアID": "エリア名"
    }
  }
}
```

## 注意点

1. **マップ名の正確性**: routing.htmlの表記を優先する
2. **双方向WP**: 多くのWPは双方向だが、片方向のみの場合もあるので注意
3. **見落とし防止**: routing.htmlに登場するがマップ一覧にないものがあれば追加（例: "橋"）
4. **条件の一貫性**: 同じ条件は同じ表記にする
5. **画像解析の限界**: 不明瞭な場合はrouting.htmlの移動順序から推論

## 既存の解析結果

Sonnetが作成した初期バージョン: `map-data.json`

このファイルと比較して、以下を確認：
- 不足しているマップ
- 不足しているWP接続
- 誤った接続情報
- 条件文の不正確さ

## 期待される成果物

1. **完全なmap-data.json**: すべてのマップとWP接続を含む
2. **差分レポート**: Sonnet版との比較（追加/修正/削除した項目）
3. **不明点リスト**: 画像やテキストから判断できなかった項目
