# ティアマト攻城戦 西ルート ナビゲーションシステム

## 📌 プロジェクト概要

**目的**: ゲーム「ティアマト攻城戦」の西ルートにおけるマップナビゲーション支援Webアプリケーション

### 基本情報
- **マップ数**: 約40マップ（塔・城壁・門・中庭など）
- **WP（ワープポイント）数**: 33接続
- **階層**: 地下〜5F（天文台）
- **エリア**: 11エリア（tower_south1, tower_southwest, tower_west, tower_northwest, tower_north1, gate1, wall2f, wall_route, courtyard, well）

### 主要機能
1. **マップ可視化**: キャビネット斜投影（Cabinet Oblique Projection）表示
2. **WP管理**: 解放状態の保存・表示（localStorage使用）
3. **階層フィルタ**: 階層ごとの表示切り替え
4. **建物表示モード**: エリアごとの建物を立方体で表示
5. **現在位置管理**: 現在のマップ位置と移動可能マップの強調表示

## 🎨 ビジュアル要件

### キャビネット斜投影（Cabinet Oblique Projection）

#### ⚠️ 最重要：投影の形状
**x軸は水平、z軸は45度斜め右上の台形グリッド！**

```
正しい配置（キャビネット斜投影）：
  ＿＿＿＿＿
 ╱╱╱╱╱╱╲     x軸 → 水平
╱╱╱╱╱╱╱╲    z軸 ↗ 45度斜め右上
￣￣￣￣￣￣￣    奥行きは50%縮小

間違い（真アイソメトリック/菱形）：
    ╱╲
   ╱╱╲╲    ← これはNG！
  ╱╱╱╲╲╲   x軸が30度傾いている
 ╱╱╱╱╲╲╲╲
```

#### 参考ゲーム
- **SimCity（初代〜3000）**: まさにこの投影方式
- **Ultima VII/Online**: 同様のビュー
- **Paperboy**: 古典的な実装例

#### 具体的な実装方法
- **Canvas 2D**: x軸は水平線、z軸は45度の斜線で描画
- **Three.js/Zdog**: `rotate: {x: 0, y: -TAU/8}` で45度回転
  - ⚠️ **重要**: x回転は必ず0！x軸を傾けてはいけない！
- **座標変換**: `x' = x - z*0.5, y' = y - z*0.5` （奥行き50%縮小）

### マップの表現
```
[台座（黒い平面/台形）]
    ↑
[マップ情報（2D平面）]
- マップ名
- 色分け（現在位置/移動可能/敵タイプ）
```

### 建物の表現
- エリアごとのマップを包含する半透明の立方体
- 通常モード: 非常に薄く表示（opacity: 0.05）
- 建物モード: はっきり表示（opacity: 0.2）

## ⚠️ UI制約（重要）

### 絶対禁止事項
1. **アニメーション禁止** - 一切のアニメーション、トランジション、動きは禁止
2. **ホバーエフェクト禁止** - マウスホバーでのポップアップ、ツールチップ禁止
3. **眼精疲労を引き起こす要素禁止**:
   - 原色の使用禁止（特に赤#ff0000、緑#00ff00）
   - 彩度の高い色は避ける
   - コントラストが強すぎる配色は避ける

### 推奨カラーパレット
```css
/* 現在位置 */
#c44444 /* 落ち着いた赤 */

/* 移動可能 */
#4a8a4a /* 落ち着いた緑（枠線のみ推奨） */

/* 敵タイプ */
#9a8650 /* 落ち着いた黄（祭祀系） */
#5a7a5a /* 落ち着いた緑（森林系） */

/* 背景・台座 */
#1a1a1a /* 背景 */
#3a3a3a /* 台座 */
#2a2a2a /* グリッド線 */
```

## 📊 データ構造

### MAP_DATA形式
```javascript
const MAP_DATA = {
  "maps": [
    {
      "id": "tower_south1_3f",      // 一意識別子
      "name": "塔・南①3F",          // 表示名
      "floor": 3,                   // 階層（0=地下、1-5=各階）
      "area": "tower_south1",        // エリア識別子
      "enemyType": "yellow",         // 敵タイプ（yellow/green/normal）
      "description": "祭祀系の敵"     // 説明（オプション）
    },
    // ... 他のマップ
  ],
  "warps": [
    {
      "from": "tower_south1_3f",    // 接続元マップID
      "to": "wall_route01",          // 接続先マップID
      "direction": "west",           // 方向（east/west/north/south/up/down）
      "locked": false                // 初期ロック状態（オプション）
    },
    // ... 他のWP接続
  ],
  "metadata": {
    "enemyTypes": {
      "yellow": "祭祀・聖職者系",
      "green": "森林・動物系",
      "normal": "通常敵"
    },
    "areas": {
      "tower_south1": "塔・南①",
      // ... 他のエリア名
    }
  }
}
```

### 座標系
- **3D座標**: `{x: 数値, z: 数値, floor: 階層}`
- **x軸**: 左右方向（0=西端、増加で東へ）
- **z軸**: 前後方向（0=北端、増加で南へ）
- **floor**: 階層（0=地下、1-5=各階）

### 方角と配置の関係
- 建物名の方角を尊重した配置
  - "south"を含む → z座標大きめ（下側）
  - "north"を含む → z座標小さめ（上側）
  - "west"を含む → x座標小さめ（左側）
  - "east"を含む → x座標大きめ（右側）

## 🔧 実装パターン

### 実行方法
**重要**: ローカルのindex.htmlファイルを直接ブラウザで開いて実行します。
HTTPサーバーは不要です。`file://`プロトコルで動作するように設計されています。

```bash
# 実行方法
# 1. ファイルマネージャーでindex.htmlをダブルクリック
# または
# 2. ブラウザにindex.htmlをドラッグ&ドロップ
# または
# 3. ブラウザのアドレスバーに file:///path/to/index.html を入力
```

### localStorage使用
```javascript
// WP解放状態の保存
const unlockedWarps = [0, 1, 5, 10]; // インデックスの配列
localStorage.setItem('unlockedWarps', JSON.stringify(unlockedWarps));

// 現在位置の保存
localStorage.setItem('currentMapId', 'tower_south1_3f');
```

### キャビネット斜投影の座標変換
```javascript
// キャビネット斜投影の変換式
function toCabinetProjection(x, z, floor) {
  // x軸は水平、z軸は45度斜め右上
  const screenX = x * scale - z * scale * 0.5;  // z方向は50%縮小
  const screenY = -z * scale * 0.5 - floor * heightScale;  // 45度の投影
  return { x: screenX + offsetX, y: screenY + offsetY };
}
```

## ⚠️ ライブラリの制限事項

### Zdog.js
**制限**: 真のキャビネット斜投影は不可能
- Zdogは透視投影（perspective）と平行投影（orthographic）のみサポート
- 斜投影（oblique projection）はネイティブサポートなし
- `rotate: {x: TAU/18, y: -TAU/8}` で「近似」は可能だが完全ではない
- x軸を完全に水平にすると、z軸の奥行きが消失する問題

### 推奨される代替案
1. **Canvas 2D直接実装**: 座標変換を自前で行えば完全なキャビネット投影が可能
2. **SVG**: 変換行列で正確な斜投影を実現可能
3. **WebGL/Three.js**: カスタムシェーダーで斜投影を実装可能

## 📝 試行錯誤の記録（詳細）

### 1. Simple版（Canvas 2D）
**場所**: `/web/simple/`
**結果**: ✅ 動作するが機能不足

#### 問題点と解決
- **問題**: 2D表示で立体感不足
- **解決策**: アイソメトリック表示への移行を決定

### 2. Isomer.js版
**場所**: `/web/isomer/`
**結果**: ⚠️ 90%完成だが真アイソメトリック（菱形）になってしまう

#### 問題点と解決
1. **角度問題**
   - **症状**: MAPが菱形に配置される
   - **原因**: depthOffsetXの符号が間違っていた
   - **解決**: `depthOffsetX = -z * GRID_SIZE * 0.4`に修正

2. **Wall巨大化問題**
   - **症状**: wall2fとwall_routeが1つの巨大な立方体に
   - **原因**: エリア単位でグループ化していた
   - **解決**: wall系は個別の建物として処理
   ```javascript
   if (map.area.startsWith('wall')) {
     areaGroups[map.id] = [map]; // 個別化
   }
   ```

3. **台形プラットフォーム角度**
   - **症状**: 左斜めになってしまった
   - **原因**: skewXの符号ミス
   - **解決**: 正しい右斜め下方向に修正

### 3. Obelisk.js版
**場所**: `/web/obelisk/`
**結果**: ❌ 制約が多すぎて要件を満たせない

#### 問題点（解決不可）
1. **角度固定問題**
   - **症状**: 30度固定でx軸水平にできない
   - **原因**: ライブラリの仕様
   - **結論**: 変更不可能

2. **偶数制約**
   - **症状**: `CubeDimension`エラー
   - **原因**: x,y,z全て偶数必須
   - **対策**: `Math.floor(value/2)*2`で丸める

3. **Color API混乱**
   - **誤**: `new obelisk.Color()`
   - **誤**: `obelisk.ColorPattern.getColor()`
   - **正**: `new obelisk.CubeColor().getByHorizontalColor()`

### 4. Zdog版
**場所**: `/web/zdog/`
**結果**: ⚠️ 複数ビューモードは実装できたが、キャビネット投影は近似のみ

#### 実装内容
1. **複数ビューモード実装**
   - 2D平面、キャビネット投影、アイソメトリック、真上ビュー
   - ビュー切り替え機能で様々な角度から確認可能

#### 問題点と制限
1. **キャビネット投影の再現性**
   - **症状**: x軸水平とz軸奥行きの両立が困難
   - **原因**: Zdogは斜投影をネイティブサポートしていない
   - **対策**: 近似的な回転角度で妥協（x: 20度, y: -45度）

2. **デグレーション問題**
   - x軸を0にするとz軸の奥行きが消失
   - x軸を傾けるとx軸が水平でなくなる
   - 修正のたびにx軸無視とz軸無視を交互に繰り返す状態

## ✅ 実装チェックリスト

新しいライブラリで実装する際は、以下を確認：

### 基本機能
- [ ] 40マップすべて表示される
- [ ] WP接続線が正しい位置に表示される
- [ ] 階層フィルタが動作する
- [ ] 現在位置が赤で強調表示される
- [ ] 移動可能マップが緑枠で表示される
- [ ] localStorage保存が動作する

### ビジュアル
- [ ] キャビネット斜投影になっている（台形グリッド）
- [ ] x軸が完全に水平
- [ ] 台座（プラットフォーム）が表示される
- [ ] 背景グリッドが表示される
- [ ] 建物モードで立方体が表示される
- [ ] 色が落ち着いている（原色なし）

### パフォーマンス
- [ ] アニメーションが一切ない
- [ ] ホバーエフェクトがない
- [ ] 描画がスムーズ
- [ ] Canvas/SVGのサイズが適切（1200x800推奨）

### Wall処理
- [ ] wall系マップが個別の建物として表示される
- [ ] 巨大な立方体にならない

## 🚀 新規実装の開始方法

1. このREADMEを読む
2. `/web/[ライブラリ名]/`ディレクトリを作成
3. 基本ファイルを配置:
   - `index.html` - 既存のHTML構造を踏襲
   - `style.css` - 既存のCSSをコピー
   - `map-data.js` - 既存のデータをコピー
   - `app.js` - ライブラリ固有の実装

4. 実装の優先順位:
   1. 基本的なマップ表示
   2. アイソメトリック変換
   3. WP接続線
   4. 階層フィルタ
   5. 現在位置/移動可能表示
   6. 建物モード

---

このREADMEは、SonnetでもOpusでも、どのAIアシスタントでも作業を継続できるように、セッション内で得た知識を永続化したものです。
